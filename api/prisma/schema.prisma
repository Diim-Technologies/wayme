generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "mysql"
  url      = env("DATABASE_URL")
}

model User {
  id                String          @id @default(cuid())
  email             String          @unique
  firstName         String
  lastName          String
  phoneNumber       String          @unique
  password          String
  role              UserRole        @default(USER)
  isVerified        Boolean         @default(false)
  kycStatus         KycStatus       @default(PENDING)
  createdAt         DateTime        @default(now())
  updatedAt         DateTime        @updatedAt
  notifications     Notification[]
  otps              OTP[]
  paymentMethods    PaymentMethod[]
  receivedTransfers Transfer[]      @relation("ReceiverTransfers")
  sentTransfers     Transfer[]      @relation("SenderTransfers")
  profile           UserProfile?

  @@map("users")
}

model UserProfile {
  id          String    @id @default(cuid())
  userId      String    @unique
  dateOfBirth DateTime?
  address     String?
  city        String?
  state       String?
  country     String    @default("NG")
  postalCode  String?
  occupation  String?
  idType      String?
  idNumber    String?
  idImageUrl  String?
  selfieUrl   String?
  createdAt   DateTime  @default(now())
  updatedAt   DateTime  @updatedAt
  user        User      @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@map("user_profiles")
}

model Transfer {
  id               String         @id @default(cuid())
  senderId         String
  receiverId       String?
  amount           Decimal        @db.Decimal(10, 2)
  fee              Decimal        @db.Decimal(10, 2)
  exchangeRate     Decimal?       @db.Decimal(10, 4)
  sourceCurrency   String         @default("NGN")
  targetCurrency   String         @default("NGN")
  purpose          String
  status           TransferStatus @default(PENDING)
  reference        String         @unique
  paymentMethodId  String
  recipientBankId  String?
  recipientAccount String?
  recipientName    String?
  recipientPhone   String?
  notes            String?
  processedAt      DateTime?
  completedAt      DateTime?
  createdAt        DateTime       @default(now())
  updatedAt        DateTime       @updatedAt
  transactions     Transaction[]
  paymentMethod    PaymentMethod  @relation(fields: [paymentMethodId], references: [id])
  receiver         User?          @relation("ReceiverTransfers", fields: [receiverId], references: [id])
  recipientBank    Bank?          @relation(fields: [recipientBankId], references: [id])
  sender           User           @relation("SenderTransfers", fields: [senderId], references: [id])

  @@index([paymentMethodId], map: "transfers_paymentMethodId_fkey")
  @@index([receiverId], map: "transfers_receiverId_fkey")
  @@index([recipientBankId], map: "transfers_recipientBankId_fkey")
  @@index([senderId], map: "transfers_senderId_fkey")
  @@map("transfers")
}

model PaymentMethod {
  id          String            @id @default(cuid())
  userId      String
  type        PaymentMethodType
  isDefault   Boolean           @default(false)
  cardDetails Json?
  bankDetails Json?
  stripeId    String?
  isActive    Boolean           @default(true)
  createdAt   DateTime          @default(now())
  updatedAt   DateTime          @updatedAt
  user        User              @relation(fields: [userId], references: [id], onDelete: Cascade)
  transfers   Transfer[]

  @@index([userId], map: "payment_methods_userId_fkey")
  @@map("payment_methods")
}

model Bank {
  id        String     @id @default(cuid())
  name      String
  code      String     @unique
  country   String     @default("NG")
  isActive  Boolean    @default(true)
  createdAt DateTime   @default(now())
  updatedAt DateTime   @updatedAt
  transfers Transfer[]

  @@map("banks")
}

model Transaction {
  id            String            @id @default(cuid())
  transferId    String
  type          TransactionType
  amount        Decimal           @db.Decimal(10, 2)
  currency      String
  status        TransactionStatus @default(PENDING)
  reference     String            @unique
  gatewayRef    String?
  gatewayData   Json?
  failureReason String?
  processedAt   DateTime?
  createdAt     DateTime          @default(now())
  updatedAt     DateTime          @updatedAt
  transfer      Transfer          @relation(fields: [transferId], references: [id], onDelete: Cascade)

  @@index([transferId], map: "transactions_transferId_fkey")
  @@map("transactions")
}

model Notification {
  id        String           @id @default(cuid())
  userId    String
  type      NotificationType
  title     String
  message   String
  isRead    Boolean          @default(false)
  data      Json?
  createdAt DateTime         @default(now())
  updatedAt DateTime         @updatedAt
  user      User             @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId], map: "notifications_userId_fkey")
  @@map("notifications")
}

model OTP {
  id        String   @id @default(cuid())
  userId    String
  code      String
  type      OTPType
  expiresAt DateTime
  isUsed    Boolean  @default(false)
  createdAt DateTime @default(now())
  user      User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId], map: "otps_userId_fkey")
  @@map("otps")
}

model ExchangeRate {
  id           String   @id @default(cuid())
  fromCurrency String
  toCurrency   String
  rate         Decimal  @db.Decimal(12, 6)
  buyRate      Decimal? @db.Decimal(12, 6)
  sellRate     Decimal? @db.Decimal(12, 6)
  source       String   @default("EXTERNAL_API")
  isActive     Boolean  @default(true)
  lastUpdated  DateTime @default(now())
  createdAt    DateTime @default(now())
  updatedAt    DateTime @updatedAt

  @@unique([fromCurrency, toCurrency])
  @@map("exchange_rates")
}

model FeeConfiguration {
  id           String   @id @default(cuid())
  name         String   @unique
  type         FeeType
  percentage   Decimal? @db.Decimal(5, 4)
  fixedAmount  Decimal? @db.Decimal(10, 2)
  minimumFee   Decimal? @db.Decimal(10, 2)
  maximumFee   Decimal? @db.Decimal(10, 2)
  currency     String   @default("NGN")
  applicableTo String?
  isActive     Boolean  @default(true)
  createdAt    DateTime @default(now())
  updatedAt    DateTime @updatedAt

  @@map("fee_configurations")
}

model SystemSetting {
  id          String   @id @default(cuid())
  key         String   @unique
  value       String
  description String?
  type        String   @default("STRING")
  isActive    Boolean  @default(true)
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  @@map("system_settings")
}

enum UserRole {
  USER
  ADMIN
  SUPER_ADMIN
}

enum KycStatus {
  PENDING
  APPROVED
  REJECTED
  UNDER_REVIEW
}

enum TransferStatus {
  PENDING
  PROCESSING
  COMPLETED
  FAILED
  CANCELLED
  REFUNDED
}

enum PaymentMethodType {
  CARD
  BANK_TRANSFER
  MOBILE_MONEY
  CRYPTO
}

enum TransactionType {
  DEBIT
  CREDIT
  FEE
  REFUND
}

enum TransactionStatus {
  PENDING
  PROCESSING
  COMPLETED
  FAILED
  CANCELLED
}

enum NotificationType {
  TRANSFER_SENT
  TRANSFER_RECEIVED
  TRANSFER_COMPLETED
  TRANSFER_FAILED
  KYC_APPROVED
  KYC_REJECTED
  PAYMENT_REMINDER
  SECURITY_ALERT
}

enum OTPType {
  PASSWORD_RESET
  EMAIL_VERIFICATION
  TWO_FACTOR_AUTH
}

enum FeeType {
  TRANSFER_FEE
  CURRENCY_CONVERSION_FEE
  WITHDRAWAL_FEE
  CARD_PROCESSING_FEE
}

